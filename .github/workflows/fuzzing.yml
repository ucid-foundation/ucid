name: Fuzzing

on:
  schedule:
    - cron: '0 4 * * 0'  # Weekly on Sundays
  workflow_dispatch:

permissions:
  contents: read

jobs:
  fuzz:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11  # v4.1.1
      - uses: actions/setup-python@82c7e631bb3cdc910f68e0081d67478d79c6982d  # v5.1.0
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install atheris hypothesis
          pip install -e "."

      - name: Run Hypothesis property-based tests
        run: |
          python -c "
          from hypothesis import given, strategies as st, settings
          from ucid import create_ucid, parse_ucid, UCIDParseError

          @given(
              lat=st.floats(min_value=-90, max_value=90, allow_nan=False),
              lon=st.floats(min_value=-180, max_value=180, allow_nan=False)
          )
          @settings(max_examples=1000)
          def test_coordinate_roundtrip(lat, lon):
              try:
                  ucid = create_ucid(
                      city='IST',
                      lat=round(lat, 3),
                      lon=round(lon, 3),
                      timestamp='2026W01T12',
                      context='15MIN'
                  )
                  parsed = parse_ucid(ucid)
                  assert parsed is not None
              except (ValueError, UCIDParseError):
                  pass  # Expected for edge cases

          test_coordinate_roundtrip()
          print('Fuzzing completed successfully')
          "

      - name: Run basic fuzz tests
        run: |
          python -c "
          import random
          import string
          from ucid import parse_ucid, UCIDParseError

          # Test random string parsing (should not crash)
          for _ in range(10000):
              random_str = ''.join(random.choices(string.ascii_letters + string.digits + ':+-', k=random.randint(1, 100)))
              try:
                  parse_ucid(random_str)
              except (UCIDParseError, ValueError, TypeError):
                  pass  # Expected

          print('Random string fuzzing completed')
          "
